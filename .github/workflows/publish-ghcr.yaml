name: Docker Image CI for GHCR

on:
  push

jobs:
  build_and_publish:
    runs-on:  ubuntu-latest
    steps:
      -
        name: GIT Checkout
        uses: actions/checkout@v3
        run: |
          echo "GIT_TAG2=$(/usr/bin/git describe --tags --abbrev=0 | sed s/\^v//g )" >> $GITHUB_ENV
      -
        name: Get git tag
        uses: little-core-labs/get-git-tag@v3.0.2
        id: tagName
        with:
          tagRegex: "[v]*(.*)"
      -
        name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}
      -
        name: Build and push the image
        run: |
          echo "the value is GIT_TAG:       $GIT_TAG"
          echo "the value is GIT_TAG_NAME:  $GIT_TAG_NAME"
          docker build . --tag ghcr.io/jmedin1965/firefox-java-vnc-flash-base:latest --tag "ghcr.io/jmedin1965/firefox-java-vnc-flash-base:$GIT_TAG"
          docker push "ghcr.io/jmedin1965/firefox-java-vnc-flash-base:latest"
          docker push "ghcr.io/jmedin1965/firefox-java-vnc-flash-base:$GIT_TAG"
